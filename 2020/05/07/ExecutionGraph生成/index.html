<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="ExcutionGraph结构:  ExcutionGraph是在服务端（JobManager处）生成的，回顾之前的流程，streamGraph生成之后进入异步流程executeAsync 1234567891011121314151617public JobClient executeAsync(StreamGraph streamGraph) throws Exception &amp;#123;">
<meta property="og:type" content="article">
<meta property="og:title" content="ExecutionGraph生成">
<meta property="og:url" content="http://yoursite.com/2020/05/07/ExecutionGraph%E7%94%9F%E6%88%90/index.html">
<meta property="og:site_name" content="HK书屋">
<meta property="og:description" content="ExcutionGraph结构:  ExcutionGraph是在服务端（JobManager处）生成的，回顾之前的流程，streamGraph生成之后进入异步流程executeAsync 1234567891011121314151617public JobClient executeAsync(StreamGraph streamGraph) throws Exception &amp;#123;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://yoursite.com/2020/05/07/ExecutionGraph%E7%94%9F%E6%88%90/1.png">
<meta property="article:published_time" content="2020-05-07T06:11:51.731Z">
<meta property="article:modified_time" content="2020-05-08T08:07:21.999Z">
<meta property="article:author" content="HH KKs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/05/07/ExecutionGraph%E7%94%9F%E6%88%90/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/05/07/ExecutionGraph生成/"/>





  <title>ExecutionGraph生成 | HK书屋</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HK书屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/07/ExecutionGraph%E7%94%9F%E6%88%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HH KKs">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HK书屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ExecutionGraph生成</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-07T14:11:51+08:00">
                2020-05-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>ExcutionGraph结构:</p>
<p><img src="/2020/05/07/ExecutionGraph%E7%94%9F%E6%88%90/1.png" alt></p>
<p>ExcutionGraph是在服务端（JobManager处）生成的，回顾之前的流程，streamGraph生成之后进入异步流程executeAsync</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public JobClient executeAsync(StreamGraph streamGraph) throws Exception &#123;</span><br><span class="line">   checkNotNull(streamGraph, &quot;StreamGraph cannot be null.&quot;);</span><br><span class="line">   checkNotNull(configuration.get(DeploymentOptions.TARGET), &quot;No execution.target specified in your configuration file.&quot;);</span><br><span class="line"></span><br><span class="line">   final PipelineExecutorFactory executorFactory &#x3D;</span><br><span class="line">      executorServiceLoader.getExecutorFactory(configuration);</span><br><span class="line"></span><br><span class="line">   checkNotNull(</span><br><span class="line">      executorFactory,</span><br><span class="line">      &quot;Cannot find compatible factory for specified execution.target (&#x3D;%s)&quot;,</span><br><span class="line">      configuration.get(DeploymentOptions.TARGET));</span><br><span class="line"></span><br><span class="line">   CompletableFuture&lt;JobClient&gt; jobClientFuture &#x3D; executorFactory</span><br><span class="line">      .getExecutor(configuration)</span><br><span class="line">      .execute(streamGraph, configuration);</span><br><span class="line">      ......</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>还是以LocalExecutor为例，异步执行LocalExecutor的excute，在excute中生成JobGraph，并启动集群，有集群客户端clusterClient将JobGraph提交至集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public CompletableFuture&lt;JobClient&gt; execute(Pipeline pipeline, Configuration configuration) throws Exception &#123;</span><br><span class="line">   checkNotNull(pipeline);</span><br><span class="line">   checkNotNull(configuration);</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; we only support attached execution with the local executor.</span><br><span class="line">   checkState(configuration.getBoolean(DeploymentOptions.ATTACHED));</span><br><span class="line"></span><br><span class="line">   final JobGraph jobGraph &#x3D; getJobGraph(pipeline, configuration);</span><br><span class="line">   final MiniCluster miniCluster &#x3D; startMiniCluster(jobGraph, configuration);</span><br><span class="line">   final MiniClusterClient clusterClient &#x3D; new MiniClusterClient(configuration, miniCluster);</span><br><span class="line"></span><br><span class="line">   CompletableFuture&lt;JobID&gt; jobIdFuture &#x3D; clusterClient.submitJob(jobGraph);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;等待submit的结果并关闭客户端</span><br><span class="line">   jobIdFuture</span><br><span class="line">         .thenCompose(clusterClient::requestJobResult)</span><br><span class="line">         .thenAccept((jobResult) -&gt; clusterClient.shutDownCluster());</span><br><span class="line"></span><br><span class="line">   return jobIdFuture.thenApply(jobID -&gt;</span><br><span class="line">         new ClusterClientJobClientAdapter&lt;&gt;(() -&gt; clusterClient, jobID));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由MiniClusterClient客户端提交至MiniCluster的submitJob，submitJob将jobGraph提交到flink集群的Dispatcher，由Dispatcher生成jobmanager</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public CompletableFuture&lt;JobSudispatcherbmissionResult&gt; submitJob(JobGraph jobGraph) &#123;</span><br><span class="line">&#x2F;&#x2F;获取dispatcher地址</span><br><span class="line">   final CompletableFuture&lt;DispatcherGateway&gt; dispatcherGatewayFuture &#x3D; getDispatcherGatewayFuture();</span><br><span class="line">   final CompletableFuture&lt;InetSocketAddress&gt; blobServerAddressFuture &#x3D; createBlobServerAddress(dispatcherGatewayFuture);</span><br><span class="line">   &#x2F;&#x2F;上传jar包至Dispatcher</span><br><span class="line">   final CompletableFuture&lt;Void&gt; jarUploadFuture &#x3D; uploadAndSetJobFiles(blobServerAddressFuture, jobGraph);</span><br><span class="line">   final CompletableFuture&lt;Acknowledge&gt; acknowledgeCompletableFuture &#x3D; jarUploadFuture</span><br><span class="line">      .thenCombine(</span><br><span class="line">         dispatcherGatewayFuture,</span><br><span class="line">         &#x2F;&#x2F;向dispatcher提交jobGraph</span><br><span class="line">         (Void ack, DispatcherGateway dispatcherGateway) -&gt; dispatcherGateway.submitJob(jobGraph, rpcTimeout))</span><br><span class="line">      .thenCompose(Function.identity());</span><br><span class="line">   return acknowledgeCompletableFuture.thenApply(</span><br><span class="line">      (Acknowledge ignored) -&gt; new JobSubmissionResult(jobGraph.getJobID()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Dispatcher类submit方法，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public CompletableFuture&lt;Acknowledge&gt; submitJob(JobGraph jobGraph, Time timeout) &#123;</span><br><span class="line">   log.info(&quot;Received JobGraph submission &#123;&#125; (&#123;&#125;).&quot;, jobGraph.getJobID(), jobGraph.getName());</span><br><span class="line"></span><br><span class="line">   try &#123;</span><br><span class="line">   &#x2F;&#x2F;重复提交的job抛出异常</span><br><span class="line">      if (isDuplicateJob(jobGraph.getJobID())) &#123;</span><br><span class="line">         return FutureUtils.completedExceptionally(</span><br><span class="line">            new DuplicateJobSubmissionException(jobGraph.getJobID()));</span><br><span class="line">            &#x2F;&#x2F;不完整的job抛出异常</span><br><span class="line">      &#125; else if (isPartialResourceConfigured(jobGraph)) &#123;</span><br><span class="line">         return FutureUtils.completedExceptionally(</span><br><span class="line">            new JobSubmissionException(jobGraph.getJobID(), &quot;Currently jobs is not supported if parts of the vertices have &quot; +</span><br><span class="line">                  &quot;resources configured. The limitation will be removed in future versions.&quot;));</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">         return internalSubmitJob(jobGraph);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; catch (FlinkException e) &#123;</span><br><span class="line">      return FutureUtils.completedExceptionally(e);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入Dispatcher类internalSubmitJob方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private CompletableFuture&lt;Acknowledge&gt; internalSubmitJob(JobGraph jobGraph) &#123;</span><br><span class="line">   log.info(&quot;Submitting job &#123;&#125; (&#123;&#125;).&quot;, jobGraph.getJobID(), jobGraph.getName());</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;终止老的JobManager并提交新的job</span><br><span class="line">   final CompletableFuture&lt;Acknowledge&gt; persistAndRunFuture &#x3D; waitForTerminatingJobManager(jobGraph.getJobID(), jobGraph, this::persistAndRunJob)</span><br><span class="line">      .thenApply(ignored -&gt; Acknowledge.get());</span><br><span class="line"></span><br><span class="line">   return persistAndRunFuture.handleAsync((acknowledge, throwable) -&gt; &#123;</span><br><span class="line">      if (throwable !&#x3D; null) &#123;</span><br><span class="line">         cleanUpJobData(jobGraph.getJobID(), true);</span><br><span class="line"></span><br><span class="line">         final Throwable strippedThrowable &#x3D; ExceptionUtils.stripCompletionException(throwable);</span><br><span class="line">         log.error(&quot;Failed to submit job &#123;&#125;.&quot;, jobGraph.getJobID(), strippedThrowable);</span><br><span class="line">         throw new CompletionException(</span><br><span class="line">            new JobSubmissionException(jobGraph.getJobID(), &quot;Failed to submit job.&quot;, strippedThrowable));</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">         return acknowledge;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;, getRpcService().getExecutor());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一下waitForTerminatingJobManager方法，就是终止相同jobId的JobManager并启动新的jobmanager，通过执行action.apply(jobGraph)，action方法是persistAndRunJob</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">private CompletableFuture&lt;Void&gt; waitForTerminatingJobManager(JobID jobId, JobGraph jobGraph, FunctionWithException&lt;JobGraph, CompletableFuture&lt;Void&gt;, ?&gt; action) &#123;</span><br><span class="line">   final CompletableFuture&lt;Void&gt; jobManagerTerminationFuture &#x3D; getJobTerminationFuture(jobId)</span><br><span class="line">      .exceptionally((Throwable throwable) -&gt; &#123;</span><br><span class="line">         throw new CompletionException(</span><br><span class="line">            new DispatcherException(</span><br><span class="line">               String.format(&quot;Termination of previous JobManager for job %s failed. Cannot submit job under the same job id.&quot;, jobId),</span><br><span class="line">               throwable)); &#125;);</span><br><span class="line"></span><br><span class="line">   return jobManagerTerminationFuture.thenComposeAsync(</span><br><span class="line">      FunctionUtils.uncheckedFunction((ignored) -&gt; &#123;</span><br><span class="line">         jobManagerTerminationFutures.remove(jobId);</span><br><span class="line">         return action.apply(jobGraph);</span><br><span class="line">      &#125;),</span><br><span class="line">      getMainThreadExecutor());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以下过程大概是提交job之后，创建JobManager，在JobManager中创建JobMaster，在JobMaster中创建Scheduler，由Scheduler创建ExecutionGraph</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">private CompletableFuture&lt;Void&gt; persistAndRunJob(JobGraph jobGraph) throws Exception &#123;</span><br><span class="line">   jobGraphWriter.putJobGraph(jobGraph);</span><br><span class="line"></span><br><span class="line">   final CompletableFuture&lt;Void&gt; runJobFuture &#x3D; runJob(jobGraph);</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private CompletableFuture&lt;Void&gt; runJob(JobGraph jobGraph) &#123;</span><br><span class="line">		&#x2F;&#x2F;这里创建JobManager</span><br><span class="line">		final CompletableFuture&lt;JobManagerRunner&gt; jobManagerRunnerFuture &#x3D; createJobManagerRunner(jobGraph);</span><br><span class="line"></span><br><span class="line">		jobManagerRunnerFutures.put(jobGraph.getJobID(), jobManagerRunnerFuture);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;创建成功启动JobManager</span><br><span class="line">		return jobManagerRunnerFuture</span><br><span class="line">			.thenApply(FunctionUtils.uncheckedFunction(this::startJobManagerRunner))</span><br><span class="line">			.thenApply(FunctionUtils.nullFn())</span><br><span class="line">			......</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	private CompletableFuture&lt;JobManagerRunner&gt; createJobManagerRunner(JobGraph jobGraph) &#123;</span><br><span class="line">		final RpcService rpcService &#x3D; getRpcService();</span><br><span class="line"></span><br><span class="line">		return CompletableFuture.supplyAsync(</span><br><span class="line">			CheckedSupplier.unchecked(() -&gt;</span><br><span class="line">			&#x2F;&#x2F;DefaultJobManagerRunnerFactory工厂类创建JobManager</span><br><span class="line">				jobManagerRunnerFactory.createJobManagerRunner(</span><br><span class="line">					jobGraph,</span><br><span class="line">					......),</span><br><span class="line">			rpcService.getExecutor());</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	public enum DefaultJobManagerRunnerFactory implements JobManagerRunnerFactory &#123;</span><br><span class="line">	INSTANCE;</span><br><span class="line">	@Override</span><br><span class="line">	public JobManagerRunner createJobManagerRunner(</span><br><span class="line">			JobGraph jobGraph,</span><br><span class="line">			......) throws Exception &#123;</span><br><span class="line">			</span><br><span class="line">&#x2F;&#x2F;DefaultJobMasterServiceFactory工厂类用来创建JobMaster</span><br><span class="line">		final JobMasterServiceFactory jobMasterFactory &#x3D; new DefaultJobMasterServiceFactory(</span><br><span class="line">			......);</span><br><span class="line"></span><br><span class="line">		return new JobManagerRunnerImpl(</span><br><span class="line">			jobGraph,</span><br><span class="line">			......);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;JobManagerRunnerImpl创建jobMaster</span><br><span class="line">public JobManagerRunnerImpl(</span><br><span class="line">			final JobGraph jobGraph,</span><br><span class="line">			......) throws Exception &#123;</span><br><span class="line">			</span><br><span class="line">		......</span><br><span class="line">			&#x2F;&#x2F; now start the JobManager，调用JobMaster的构造函数</span><br><span class="line">			this.jobMasterService &#x3D; jobMasterFactory.createJobMasterService(jobGraph, this, userCodeLoader);</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F;进入JobMaster类构造函数</span><br><span class="line">	public JobMaster(</span><br><span class="line">			......</span><br><span class="line">			JobGraph jobGraph,</span><br><span class="line">			......) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		......</span><br><span class="line">		&#x2F;&#x2F;创建flink job的调度类，通过DefaultSchedulerFactory工厂类的createInstance创建实例</span><br><span class="line">		this.schedulerNG &#x3D; createScheduler(jobManagerJobMetricGroup);</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F;获取DefaultSchedulerFactory的DefaultScheduler</span><br><span class="line">	public class DefaultSchedulerFactory implements SchedulerNGFactory &#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public SchedulerNG createInstance(</span><br><span class="line">	       final JobGraph jobGraph,</span><br><span class="line">			......) throws Exception &#123;</span><br><span class="line">	</span><br><span class="line">      ......</span><br><span class="line">		return new DefaultScheduler(jobGraph,......);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F;DefaultScheduler继承自SchedulerBase类，初始化DefaultScheduler要先初始化SchedulerBase</span><br><span class="line">	public SchedulerBase(</span><br><span class="line">		final JobGraph jobGraph,</span><br><span class="line">		......) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		......</span><br><span class="line">		&#x2F;&#x2F;到这里终于开始创建ExecutionGraph</span><br><span class="line">		this.executionGraph &#x3D; createAndRestoreExecutionGraph(jobManagerJobMetricGroup, checkNotNull(shuffleMaster), checkNotNull(partitionTracker));</span><br><span class="line">		......</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>进入ExecutionGraph的创建逻辑SchedulerBase#createExecutionGraph</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">private ExecutionGraph createExecutionGraph(</span><br><span class="line">   JobManagerJobMetricGroup currentJobManagerJobMetricGroup,</span><br><span class="line">   ShuffleMaster&lt;?&gt; shuffleMaster,</span><br><span class="line">   final JobMasterPartitionTracker partitionTracker) throws JobExecutionException, JobException &#123;</span><br><span class="line"></span><br><span class="line">   final FailoverStrategy.Factory failoverStrategy &#x3D; legacyScheduling ?</span><br><span class="line">      FailoverStrategyLoader.loadFailoverStrategy(jobMasterConfiguration, log) :</span><br><span class="line">      new NoOpFailoverStrategy.Factory();</span><br><span class="line"></span><br><span class="line">   return ExecutionGraphBuilder.buildGraph(</span><br><span class="line">      null,</span><br><span class="line">      jobGraph,</span><br><span class="line">      jobMasterConfiguration,</span><br><span class="line">      futureExecutor,</span><br><span class="line">      ioExecutor,</span><br><span class="line">      slotProvider,</span><br><span class="line">      userCodeLoader,</span><br><span class="line">      checkpointRecoveryFactory,</span><br><span class="line">      rpcTimeout,</span><br><span class="line">      restartStrategy,</span><br><span class="line">      currentJobManagerJobMetricGroup,</span><br><span class="line">      blobWriter,</span><br><span class="line">      slotRequestTimeout,</span><br><span class="line">      log,</span><br><span class="line">      shuffleMaster,</span><br><span class="line">      partitionTracker,</span><br><span class="line">      failoverStrategy);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键方法是ExecutionGraphBuilder.buildGraph</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">public static ExecutionGraph buildGraph(</span><br><span class="line">   @Nullable ExecutionGraph prior,</span><br><span class="line">   JobGraph jobGraph,</span><br><span class="line">   Configuration jobManagerConfig,</span><br><span class="line">   ScheduledExecutorService futureExecutor,</span><br><span class="line">   Executor ioExecutor,</span><br><span class="line">   SlotProvider slotProvider,</span><br><span class="line">   ClassLoader classLoader,</span><br><span class="line">   CheckpointRecoveryFactory recoveryFactory,</span><br><span class="line">   Time rpcTimeout,</span><br><span class="line">   RestartStrategy restartStrategy,</span><br><span class="line">   MetricGroup metrics,</span><br><span class="line">   BlobWriter blobWriter,</span><br><span class="line">   Time allocationTimeout,</span><br><span class="line">   Logger log,</span><br><span class="line">   ShuffleMaster&lt;?&gt; shuffleMaster,</span><br><span class="line">   JobMasterPartitionTracker partitionTracker,</span><br><span class="line">   FailoverStrategy.Factory failoverStrategyFactory) throws JobExecutionException, JobException &#123;</span><br><span class="line"></span><br><span class="line">   checkNotNull(jobGraph, &quot;job graph cannot be null&quot;);</span><br><span class="line"></span><br><span class="line">   final String jobName &#x3D; jobGraph.getName();</span><br><span class="line">   final JobID jobId &#x3D; jobGraph.getJobID();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;创建JobInformation</span><br><span class="line">   final JobInformation jobInformation &#x3D; new JobInformation(</span><br><span class="line">      jobId,</span><br><span class="line">      jobName,</span><br><span class="line">      jobGraph.getSerializedExecutionConfig(),</span><br><span class="line">      jobGraph.getJobConfiguration(),</span><br><span class="line">      jobGraph.getUserJarBlobKeys(),</span><br><span class="line">      jobGraph.getClasspaths());</span><br><span class="line"></span><br><span class="line">   final int maxPriorAttemptsHistoryLength &#x3D;</span><br><span class="line">         jobManagerConfig.getInteger(JobManagerOptions.MAX_ATTEMPTS_HISTORY_SIZE);</span><br><span class="line"></span><br><span class="line">   final PartitionReleaseStrategy.Factory partitionReleaseStrategyFactory &#x3D;</span><br><span class="line">      PartitionReleaseStrategyFactoryLoader.loadPartitionReleaseStrategyFactory(jobManagerConfig);</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; create a new execution graph, if none exists so far</span><br><span class="line">   &#x2F;&#x2F;新建ExecutionGraph类</span><br><span class="line">   final ExecutionGraph executionGraph;</span><br><span class="line">   try &#123;</span><br><span class="line">      executionGraph &#x3D; (prior !&#x3D; null) ? prior :</span><br><span class="line">         new ExecutionGraph(</span><br><span class="line">            jobInformation,</span><br><span class="line">            futureExecutor,</span><br><span class="line">            ioExecutor,</span><br><span class="line">            rpcTimeout,</span><br><span class="line">            restartStrategy,</span><br><span class="line">            maxPriorAttemptsHistoryLength,</span><br><span class="line">            failoverStrategyFactory,</span><br><span class="line">            slotProvider,</span><br><span class="line">            classLoader,</span><br><span class="line">            blobWriter,</span><br><span class="line">            allocationTimeout,</span><br><span class="line">            partitionReleaseStrategyFactory,</span><br><span class="line">            shuffleMaster,</span><br><span class="line">            partitionTracker,</span><br><span class="line">            jobGraph.getScheduleMode());</span><br><span class="line">   &#125; catch (IOException e) &#123;</span><br><span class="line">      throw new JobException(&quot;Could not create the ExecutionGraph.&quot;, e);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; set the basic properties</span><br><span class="line">&#x2F;&#x2F;设置JsonPlan</span><br><span class="line">   try &#123;</span><br><span class="line">      executionGraph.setJsonPlan(JsonPlanGenerator.generatePlan(jobGraph));</span><br><span class="line">   &#125;</span><br><span class="line">   catch (Throwable t) &#123;</span><br><span class="line">      log.warn(&quot;Cannot create JSON plan for job&quot;, t);</span><br><span class="line">      &#x2F;&#x2F; give the graph an empty plan</span><br><span class="line">      executionGraph.setJsonPlan(&quot;&#123;&#125;&quot;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; initialize the vertices that have a master initialization hook</span><br><span class="line">   &#x2F;&#x2F; file output formats create directories here, input formats create splits</span><br><span class="line"></span><br><span class="line">   final long initMasterStart &#x3D; System.nanoTime();</span><br><span class="line">   log.info(&quot;Running initialization on master for job &#123;&#125; (&#123;&#125;).&quot;, jobName, jobId);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;遍历JobVertex节点并在Master上初始化，主要关注OutputFormatVertex 和 InputFormatVertex，其他类型的 vertex 在这里没有什么特殊操作。File output format 在这一步准备好输出目录, Input splits 在这一步创建对应的 splits。</span><br><span class="line">   for (JobVertex vertex : jobGraph.getVertices()) &#123;</span><br><span class="line">      String executableClass &#x3D; vertex.getInvokableClassName();</span><br><span class="line">      if (executableClass &#x3D;&#x3D; null || executableClass.isEmpty()) &#123;</span><br><span class="line">         throw new JobSubmissionException(jobId,</span><br><span class="line">               &quot;The vertex &quot; + vertex.getID() + &quot; (&quot; + vertex.getName() + &quot;) has no invokable class.&quot;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">         vertex.initializeOnMaster(classLoader);</span><br><span class="line">      &#125;</span><br><span class="line">      catch (Throwable t) &#123;</span><br><span class="line">            throw new JobExecutionException(jobId,</span><br><span class="line">                  &quot;Cannot initialize task &#39;&quot; + vertex.getName() + &quot;&#39;: &quot; + t.getMessage(), t);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   log.info(&quot;Successfully ran initialization on master in &#123;&#125; ms.&quot;,</span><br><span class="line">         (System.nanoTime() - initMasterStart) &#x2F; 1_000_000);</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; topologically sort the job vertices and attach the graph to the existing one</span><br><span class="line">   &#x2F;&#x2F;对所有的 Jobvertext 进行拓扑排序，并生成 ExecutionGraph 内部的节点和连接，所谓拓扑排序，即保证如果存在 A -&gt; B 的有向边，那么在排序后的列表中 A 节点一定在 B 节点之前。</span><br><span class="line">   List&lt;JobVertex&gt; sortedTopology &#x3D; jobGraph.getVerticesSortedTopologicallyFromSources();</span><br><span class="line">   if (log.isDebugEnabled()) &#123;</span><br><span class="line">      log.debug(&quot;Adding &#123;&#125; vertices from job graph &#123;&#125; (&#123;&#125;).&quot;, sortedTopology.size(), jobName, jobId);</span><br><span class="line">   &#125;</span><br><span class="line">   &#x2F;&#x2F;核心方法，生成executionGraph的节点</span><br><span class="line">   executionGraph.attachJobGraph(sortedTopology);</span><br><span class="line"></span><br><span class="line">   ......(省略的部分均为checkpointing 相关逻辑)</span><br><span class="line"></span><br><span class="line">   return executionGraph;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要逻辑是ExecutionGraph#attachJobGraph,在创建 <code>ExecutionJobVertex</code> 的时候会创建对应的 <code>ExecutionVertex</code>， <code>IntermediateResult</code>，<code>ExecutionEdge</code> ， <code>IntermediateResultPartition</code> 等对象，这里涉及到的对象相对较多，概括起来大致是这样的：</p>
<ul>
<li>每一个 <code>JobVertex</code> 对应一个 ExecutionJobVertex,</li>
<li>每一个 <code>ExecutionJobVertex</code> 有 parallelism 个 <code>ExecutionVertex</code></li>
<li>每一个 <code>JobVertex</code> 可能有 n(n&gt;=0) 个 <code>IntermediateDataSet</code>，在 <code>ExecutionJobVertex</code> 中，一个 <code>IntermediateDataSet</code> 对应一个 <code>IntermediateResult</code>, 每一个 <code>IntermediateResult</code> 都有 parallelism 个生产者, 对应 parallelism 个<code>IntermediateResultPartition</code></li>
<li>每一个 <code>ExecutionJobVertex</code> 都会和前向的 <code>IntermediateResult</code> 连接，实际上是 <code>ExecutionVertex</code>和 <code>IntermediateResult</code> 建立连接，生成 <code>ExecutionEdge</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public void attachJobGraph(List&lt;JobVertex&gt; topologiallySorted) throws JobException &#123;</span><br><span class="line"></span><br><span class="line">   for (JobVertex jobVertex : topologiallySorted) &#123;</span><br><span class="line"></span><br><span class="line">      if (jobVertex.isInputVertex() &amp;&amp; !jobVertex.isStoppable()) &#123;</span><br><span class="line">         this.isStoppable &#x3D; false;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F; create the execution job vertex and attach it to the graph</span><br><span class="line">      &#x2F;&#x2F;在这里生成ExecutionGraph的每个节点</span><br><span class="line">            &#x2F;&#x2F;首先是进行了一堆赋值，将任务信息交给要生成的图节点，以及设定并行度等等</span><br><span class="line">            &#x2F;&#x2F;然后是创建本节点的IntermediateResult，根据本节点的下游节点的个数确定创建几份</span><br><span class="line">            &#x2F;&#x2F;最后是根据设定好的并行度创建用于执行task的ExecutionVertex</span><br><span class="line">            &#x2F;&#x2F;如果job有设定inputsplit的话，这里还要指定inputsplits</span><br><span class="line">      ExecutionJobVertex ejv &#x3D; new ExecutionJobVertex(</span><br><span class="line">            this,</span><br><span class="line">            jobVertex,</span><br><span class="line">            1,</span><br><span class="line">            maxPriorAttemptsHistoryLength,</span><br><span class="line">            rpcTimeout,</span><br><span class="line">            globalModVersion,</span><br><span class="line">            createTimestamp);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;这里要处理所有的JobEdge</span><br><span class="line">            &#x2F;&#x2F;对每个edge，获取对应的intermediateResult，并记录到本节点的输入上</span><br><span class="line">            &#x2F;&#x2F;最后，把每个ExecutorVertex和对应的IntermediateResult关联起来</span><br><span class="line">      ejv.connectToPredecessors(this.intermediateResults);</span><br><span class="line"></span><br><span class="line">      ExecutionJobVertex previousTask &#x3D; this.tasks.putIfAbsent(jobVertex.getID(), ejv);</span><br><span class="line">      if (previousTask !&#x3D; null) &#123;</span><br><span class="line">         throw new JobException(String.format(&quot;Encountered two job vertices with ID %s : previous&#x3D;[%s] &#x2F; new&#x3D;[%s]&quot;,</span><br><span class="line">            jobVertex.getID(), ejv, previousTask));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      for (IntermediateResult res : ejv.getProducedDataSets()) &#123;</span><br><span class="line">         IntermediateResult previousDataSet &#x3D; this.intermediateResults.putIfAbsent(res.getId(), res);</span><br><span class="line">         if (previousDataSet !&#x3D; null) &#123;</span><br><span class="line">            throw new JobException(String.format(&quot;Encountered two intermediate data set with ID %s : previous&#x3D;[%s] &#x2F; new&#x3D;[%s]&quot;,</span><br><span class="line">               res.getId(), res, previousDataSet));</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      this.verticesInCreationOrder.add(ejv);</span><br><span class="line">      this.numVerticesTotal +&#x3D; ejv.getParallelism();</span><br><span class="line">      newExecJobVertices.add(ejv);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; the topology assigning should happen before notifying new vertices to failoverStrategy</span><br><span class="line">   executionTopology &#x3D; new DefaultExecutionTopology(this);</span><br><span class="line"></span><br><span class="line">   failoverStrategy.notifyNewVertices(newExecJobVertices);</span><br><span class="line"></span><br><span class="line">   partitionReleaseStrategy &#x3D; partitionReleaseStrategyFactory.createInstance(getSchedulingTopology());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ExecutionJobVertex,在 <code>ExecutionGraph</code> 中，节点对应的类是 <code>ExecutionJobVertex</code>，与之对应的就是 <code>JobGraph</code> 中的 <code>JobVertex</code>。每一个 <code>ExexutionJobVertex</code> 都是由一个 <code>JobVertex</code> 生成的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">public class ExecutionJobVertex implements AccessExecutionJobVertex, Archiveable&lt;ArchivedExecutionJobVertex&gt; &#123;</span><br><span class="line"></span><br><span class="line">	&#x2F;** Use the same log for all ExecutionGraph classes. *&#x2F;</span><br><span class="line">	private static final Logger LOG &#x3D; ExecutionGraph.LOG;</span><br><span class="line"></span><br><span class="line">	public static final int VALUE_NOT_SET &#x3D; -1;</span><br><span class="line"></span><br><span class="line">	private final Object stateMonitor &#x3D; new Object();</span><br><span class="line"></span><br><span class="line">	private final ExecutionGraph graph;</span><br><span class="line"></span><br><span class="line">	private final JobVertex jobVertex;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * The IDs of all operators contained in this execution job vertex.</span><br><span class="line">	 *</span><br><span class="line">	 * &lt;p&gt;The ID&#39;s are stored depth-first post-order; for the forking chain below the ID&#39;s would be stored as [D, E, B, C, A].</span><br><span class="line">	 *  A - B - D</span><br><span class="line">	 *   \    \</span><br><span class="line">	 *    C    E</span><br><span class="line">	 * This is the same order that operators are stored in the &#123;@code StreamTask&#125;.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private final List&lt;OperatorID&gt; operatorIDs;</span><br><span class="line"></span><br><span class="line">	&#x2F;**</span><br><span class="line">	 * The alternative IDs of all operators contained in this execution job vertex.</span><br><span class="line">	 *</span><br><span class="line">	 * &lt;p&gt;The ID&#39;s are in the same order as &#123;@link ExecutionJobVertex#operatorIDs&#125;.</span><br><span class="line">	 *&#x2F;</span><br><span class="line">	private final List&lt;OperatorID&gt; userDefinedOperatorIds;</span><br><span class="line"></span><br><span class="line">	private final ExecutionVertex[] taskVertices;</span><br><span class="line"></span><br><span class="line">	private final IntermediateResult[] producedDataSets;</span><br><span class="line"></span><br><span class="line">	private final List&lt;IntermediateResult&gt; inputs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">public ExecutionJobVertex(</span><br><span class="line">      ExecutionGraph graph,</span><br><span class="line">      JobVertex jobVertex,</span><br><span class="line">      int defaultParallelism,</span><br><span class="line">      int maxPriorAttemptsHistoryLength,</span><br><span class="line">      Time timeout,</span><br><span class="line">      long initialGlobalModVersion,</span><br><span class="line">      long createTimestamp) throws JobException &#123;</span><br><span class="line"></span><br><span class="line">   if (graph &#x3D;&#x3D; null || jobVertex &#x3D;&#x3D; null) &#123;</span><br><span class="line">      throw new NullPointerException();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   this.graph &#x3D; graph;</span><br><span class="line">   this.jobVertex &#x3D; jobVertex;</span><br><span class="line"></span><br><span class="line">   int vertexParallelism &#x3D; jobVertex.getParallelism();</span><br><span class="line">   int numTaskVertices &#x3D; vertexParallelism &gt; 0 ? vertexParallelism : defaultParallelism;</span><br><span class="line"></span><br><span class="line">   final int configuredMaxParallelism &#x3D; jobVertex.getMaxParallelism();</span><br><span class="line"></span><br><span class="line">   this.maxParallelismConfigured &#x3D; (VALUE_NOT_SET !&#x3D; configuredMaxParallelism);</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; if no max parallelism was configured by the user, we calculate and set a default</span><br><span class="line">   setMaxParallelismInternal(maxParallelismConfigured ?</span><br><span class="line">         configuredMaxParallelism : KeyGroupRangeAssignment.computeDefaultMaxParallelism(numTaskVertices));</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; verify that our parallelism is not higher than the maximum parallelism</span><br><span class="line">   if (numTaskVertices &gt; maxParallelism) &#123;</span><br><span class="line">      throw new JobException(</span><br><span class="line">         String.format(&quot;Vertex %s&#39;s parallelism (%s) is higher than the max parallelism (%s). Please lower the parallelism or increase the max parallelism.&quot;,</span><br><span class="line">            jobVertex.getName(),</span><br><span class="line">            numTaskVertices,</span><br><span class="line">            maxParallelism));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   this.parallelism &#x3D; numTaskVertices;</span><br><span class="line">   this.resourceProfile &#x3D; ResourceProfile.fromResourceSpec(jobVertex.getMinResources(), MemorySize.ZERO);</span><br><span class="line"></span><br><span class="line">   this.taskVertices &#x3D; new ExecutionVertex[numTaskVertices];</span><br><span class="line">   this.operatorIDs &#x3D; Collections.unmodifiableList(jobVertex.getOperatorIDs());</span><br><span class="line">   this.userDefinedOperatorIds &#x3D; Collections.unmodifiableList(jobVertex.getUserDefinedOperatorIDs());</span><br><span class="line"></span><br><span class="line">   this.inputs &#x3D; new ArrayList&lt;&gt;(jobVertex.getInputs().size());</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; take the sharing group</span><br><span class="line">   this.slotSharingGroup &#x3D; jobVertex.getSlotSharingGroup();</span><br><span class="line">   this.coLocationGroup &#x3D; jobVertex.getCoLocationGroup();</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; setup the coLocation group</span><br><span class="line">   if (coLocationGroup !&#x3D; null &amp;&amp; slotSharingGroup &#x3D;&#x3D; null) &#123;</span><br><span class="line">      throw new JobException(&quot;Vertex uses a co-location constraint without using slot sharing&quot;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; create the intermediate results</span><br><span class="line">   &#x2F;&#x2F;根据jobGraph的IntermediateDataSet生成IntermediateResult，但是会传入并行度参数numTaskVertices，根据并行度在IntermediateResult内部会生成numTaskVertices个IntermediateResultPartition分区。</span><br><span class="line">   </span><br><span class="line">   this.producedDataSets &#x3D; new IntermediateResult[jobVertex.getNumberOfProducedIntermediateDataSets()];</span><br><span class="line"></span><br><span class="line">   for (int i &#x3D; 0; i &lt; jobVertex.getProducedDataSets().size(); i++) &#123;</span><br><span class="line">      final IntermediateDataSet result &#x3D; jobVertex.getProducedDataSets().get(i);</span><br><span class="line"></span><br><span class="line">      this.producedDataSets[i] &#x3D; new IntermediateResult(</span><br><span class="line">            result.getId(),</span><br><span class="line">            this,</span><br><span class="line">            numTaskVertices,</span><br><span class="line">            result.getResultType());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; create all task vertices</span><br><span class="line">   &#x2F;&#x2F;一个ExecutionJobVertex对应numTaskVertices个ExecutionVertex节点</span><br><span class="line">   for (int i &#x3D; 0; i &lt; numTaskVertices; i++) &#123;</span><br><span class="line">      ExecutionVertex vertex &#x3D; new ExecutionVertex(</span><br><span class="line">            this,</span><br><span class="line">            i,</span><br><span class="line">            producedDataSets,</span><br><span class="line">            timeout,</span><br><span class="line">            initialGlobalModVersion,</span><br><span class="line">            createTimestamp,</span><br><span class="line">            maxPriorAttemptsHistoryLength);</span><br><span class="line"></span><br><span class="line">      this.taskVertices[i] &#x3D; vertex;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; sanity check for the double referencing between intermediate result partitions and execution vertices</span><br><span class="line">   for (IntermediateResult ir : this.producedDataSets) &#123;</span><br><span class="line">      if (ir.getNumberOfAssignedPartitions() !&#x3D; parallelism) &#123;</span><br><span class="line">         throw new RuntimeException(&quot;The intermediate result&#39;s partitions were not correctly assigned.&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; set up the input splits, if the vertex has any</span><br><span class="line">   try &#123;</span><br><span class="line">      @SuppressWarnings(&quot;unchecked&quot;)</span><br><span class="line">      InputSplitSource&lt;InputSplit&gt; splitSource &#x3D; (InputSplitSource&lt;InputSplit&gt;) jobVertex.getInputSplitSource();</span><br><span class="line"></span><br><span class="line">      if (splitSource !&#x3D; null) &#123;</span><br><span class="line">         Thread currentThread &#x3D; Thread.currentThread();</span><br><span class="line">         ClassLoader oldContextClassLoader &#x3D; currentThread.getContextClassLoader();</span><br><span class="line">         currentThread.setContextClassLoader(graph.getUserClassLoader());</span><br><span class="line">         try &#123;</span><br><span class="line">            inputSplits &#x3D; splitSource.createInputSplits(numTaskVertices);</span><br><span class="line"></span><br><span class="line">            if (inputSplits !&#x3D; null) &#123;</span><br><span class="line">               splitAssigner &#x3D; splitSource.getInputSplitAssigner(inputSplits);</span><br><span class="line">            &#125;</span><br><span class="line">         &#125; finally &#123;</span><br><span class="line">            currentThread.setContextClassLoader(oldContextClassLoader);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      else &#123;</span><br><span class="line">         inputSplits &#x3D; null;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   catch (Throwable t) &#123;</span><br><span class="line">      throw new JobException(&quot;Creating the input splits caused an error: &quot; + t.getMessage(), t);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于 <code>ExecutionJobVertex</code> 有 numParallelProducers 个并行的子任务，自然对应的每一个 <code>IntermediateResult</code> 就有 numParallelProducers 个生产者，每个生产者的在相应的 <code>IntermediateResult</code>上的输出对应一个 <code>IntermediateResultPartition</code>。<code>IntermediateResultPartition</code> 表示的是 <code>ExecutionVertex</code> 的一个输出分区，</p>
<p>一个 <code>ExecutionJobVertex</code> 可能包含多个（n） 个 <code>IntermediateResult</code>， 那实际上每一个并行的子任务 <code>ExecutionVertex</code> 可能会会包含（n） 个 <code>IntermediateResultPartition</code>。</p>
<p>IntermediateResultPartition<code>的生产者是</code>ExecutionVertex<code>，消费者是一个或若干个</code>ExecutionEdge</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class IntermediateResult &#123;</span><br><span class="line"></span><br><span class="line">   private final IntermediateDataSetID id;</span><br><span class="line"></span><br><span class="line">   private final ExecutionJobVertex producer;</span><br><span class="line"></span><br><span class="line">   private final IntermediateResultPartition[] partitions;</span><br><span class="line"></span><br><span class="line">   &#x2F;**</span><br><span class="line">    * Maps intermediate result partition IDs to a partition index. This is</span><br><span class="line">    * used for ID lookups of intermediate results. I didn&#39;t dare to change the</span><br><span class="line">    * partition connect logic in other places that is tightly coupled to the</span><br><span class="line">    * partitions being held as an array.</span><br><span class="line">    *&#x2F;</span><br><span class="line">   private final HashMap&lt;IntermediateResultPartitionID, Integer&gt; partitionLookupHelper &#x3D; new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">   private final int numParallelProducers;</span><br><span class="line"></span><br><span class="line">   private final AtomicInteger numberOfRunningProducers;</span><br><span class="line"></span><br><span class="line">   private int partitionsAssigned;</span><br><span class="line"></span><br><span class="line">   private int numConsumers;</span><br><span class="line"></span><br><span class="line">   private final int connectionIndex;</span><br><span class="line"></span><br><span class="line">   private final ResultPartitionType resultType;</span><br></pre></td></tr></table></figure>

<p><code>ExexutionJobVertex</code> 的成员变量中包含一个 <code>ExecutionVertex</code> 数组。我们知道，Flink Job 是可以指定任务的并行度的，在实际运行时，会有多个并行的任务同时在执行，对应到这里就是 <code>ExecutionVertex</code>。<code>ExecutionVertex</code> 是并行任务的一个子任务，算子的并行度是多少，那么就会有多少个 <code>ExecutionVertex</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">public class ExecutionVertex implements AccessExecutionVertex, Archiveable&lt;ArchivedExecutionVertex&gt; &#123;</span><br><span class="line"></span><br><span class="line">	private final ExecutionJobVertex jobVertex;</span><br><span class="line"></span><br><span class="line">	private final Map&lt;IntermediateResultPartitionID, IntermediateResultPartition&gt; resultPartitions;</span><br><span class="line"></span><br><span class="line">	private final ExecutionEdge[][] inputEdges;</span><br><span class="line"></span><br><span class="line">	private final int subTaskIndex;</span><br><span class="line"></span><br><span class="line">	private final ExecutionVertexID executionVertexId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public ExecutionVertex(</span><br><span class="line">      ExecutionJobVertex jobVertex,</span><br><span class="line">      int subTaskIndex,</span><br><span class="line">      IntermediateResult[] producedDataSets,</span><br><span class="line">      Time timeout,</span><br><span class="line">      long initialGlobalModVersion,</span><br><span class="line">      long createTimestamp,</span><br><span class="line">      int maxPriorExecutionHistoryLength) &#123;</span><br><span class="line"></span><br><span class="line">   this.jobVertex &#x3D; jobVertex;</span><br><span class="line">   this.subTaskIndex &#x3D; subTaskIndex;</span><br><span class="line">   this.executionVertexId &#x3D; new ExecutionVertexID(jobVertex.getJobVertexId(), subTaskIndex);</span><br><span class="line">   this.taskNameWithSubtask &#x3D; String.format(&quot;%s (%d&#x2F;%d)&quot;,</span><br><span class="line">         jobVertex.getJobVertex().getName(), subTaskIndex + 1, jobVertex.getParallelism());</span><br><span class="line"></span><br><span class="line">   this.resultPartitions &#x3D; new LinkedHashMap&lt;&gt;(producedDataSets.length, 1);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;对每个下游IntermediateResult，都创建并行度数量的分区IntermediateResultPartition</span><br><span class="line">   for (IntermediateResult result : producedDataSets) &#123;</span><br><span class="line">      IntermediateResultPartition irp &#x3D; new IntermediateResultPartition(result, this, subTaskIndex);</span><br><span class="line">      result.setPartition(subTaskIndex, irp);</span><br><span class="line"></span><br><span class="line">      resultPartitions.put(irp.getPartitionId(), irp);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;初始化边ExecutionEdge</span><br><span class="line">   this.inputEdges &#x3D; new ExecutionEdge[jobVertex.getJobVertex().getInputs().size()][];</span><br><span class="line"></span><br><span class="line">   this.priorExecutions &#x3D; new EvictingBoundedList&lt;&gt;(maxPriorExecutionHistoryLength);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;初始化Execution，Execution 是对 ExecutionVertex 的一次执行，通过 ExecutionAttemptId 来唯一标识。</span><br><span class="line">   this.currentExecution &#x3D; new Execution(</span><br><span class="line">      getExecutionGraph().getFutureExecutor(),</span><br><span class="line">      this,</span><br><span class="line">      0,</span><br><span class="line">      initialGlobalModVersion,</span><br><span class="line">      createTimestamp,</span><br><span class="line">      timeout);</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; create a co-location scheduling hint, if necessary</span><br><span class="line">   CoLocationGroup clg &#x3D; jobVertex.getCoLocationGroup();</span><br><span class="line">   if (clg !&#x3D; null) &#123;</span><br><span class="line">      this.locationConstraint &#x3D; clg.getLocationConstraint(subTaskIndex);</span><br><span class="line">   &#125;</span><br><span class="line">   else &#123;</span><br><span class="line">      this.locationConstraint &#x3D; null;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   getExecutionGraph().registerExecution(currentExecution);</span><br><span class="line"></span><br><span class="line">   this.timeout &#x3D; timeout;</span><br><span class="line">   this.inputSplits &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ExecutionEdge</code> 表示 <code>ExecutionVertex</code> 的输入，通过 <code>ExecutionEdge</code> 将 <code>ExecutionVertex</code> 和 <code>IntermediateResultPartition</code> 连接起来，进而在不同的 <code>ExecutionVertex</code> 之间建立联系。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class ExecutionEdge &#123;</span><br><span class="line"></span><br><span class="line">   private final IntermediateResultPartition source;</span><br><span class="line"></span><br><span class="line">   private final ExecutionVertex target;</span><br><span class="line"></span><br><span class="line">   private final int inputNum;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/05/06/JobGraph%E7%94%9F%E6%88%90/" rel="next" title="JobGraph生成">
                <i class="fa fa-chevron-left"></i> JobGraph生成
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/28/Flink%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B/" rel="prev" title="Flink客户端提交流程">
                Flink客户端提交流程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">HH KKs</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HH KKs</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
