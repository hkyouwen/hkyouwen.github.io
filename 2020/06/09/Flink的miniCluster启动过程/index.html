<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="flink的PipelineExecutor分为远程和本地，以本地环境为例，看下miniCluster启动过程。入口在本地环境LocalExecutor的excute方法里。先根据streamGraph生成JobGraph，再启动MiniCluster，然后将JobGraph提交至MiniCluster。 12345678910public CompletableFuture&lt;JobClie">
<meta property="og:type" content="article">
<meta property="og:title" content="Flink的miniCluster启动过程">
<meta property="og:url" content="http://yoursite.com/2020/06/09/Flink%E7%9A%84miniCluster%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/index.html">
<meta property="og:site_name" content="HK书屋">
<meta property="og:description" content="flink的PipelineExecutor分为远程和本地，以本地环境为例，看下miniCluster启动过程。入口在本地环境LocalExecutor的excute方法里。先根据streamGraph生成JobGraph，再启动MiniCluster，然后将JobGraph提交至MiniCluster。 12345678910public CompletableFuture&lt;JobClie">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-06-09T08:19:13.512Z">
<meta property="article:modified_time" content="2020-06-10T09:19:04.051Z">
<meta property="article:author" content="HH KKs">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/09/Flink的miniCluster启动过程/"/>





  <title>Flink的miniCluster启动过程 | HK书屋</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HK书屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/09/Flink%E7%9A%84miniCluster%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HH KKs">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HK书屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Flink的miniCluster启动过程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-09T16:19:13+08:00">
                2020-06-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>flink的PipelineExecutor分为远程和本地，以本地环境为例，看下miniCluster启动过程。入口在本地环境LocalExecutor的excute方法里。先根据streamGraph生成JobGraph，再启动MiniCluster，然后将JobGraph提交至MiniCluster。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public CompletableFuture&lt;JobClient&gt; execute(Pipeline pipeline, Configuration configuration) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">   final JobGraph jobGraph &#x3D; getJobGraph(pipeline, configuration);</span><br><span class="line">   final MiniCluster miniCluster &#x3D; startMiniCluster(jobGraph, configuration);</span><br><span class="line">   final MiniClusterClient clusterClient &#x3D; new MiniClusterClient(configuration, miniCluster);</span><br><span class="line"></span><br><span class="line">   CompletableFuture&lt;JobID&gt; jobIdFuture &#x3D; clusterClient.submitJob(jobGraph);</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看下startMiniCluster的过程，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">private MiniCluster startMiniCluster(final JobGraph jobGraph, final Configuration configuration) throws Exception &#123;</span><br><span class="line">   if (!configuration.contains(RestOptions.BIND_PORT)) &#123;</span><br><span class="line">      configuration.setString(RestOptions.BIND_PORT, &quot;0&quot;);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;要启动的TaskManager个数，由local.number-taskmanager配置，默认为1</span><br><span class="line">   int numTaskManagers &#x3D; configuration.getInteger(</span><br><span class="line">         ConfigConstants.LOCAL_NUMBER_TASK_MANAGER,</span><br><span class="line">         ConfigConstants.DEFAULT_LOCAL_NUMBER_TASK_MANAGER);</span><br><span class="line"></span><br><span class="line">   &#x2F;&#x2F; we have to use the maximum parallelism as a default here, otherwise streaming</span><br><span class="line">   &#x2F;&#x2F; pipelines would not run</span><br><span class="line">   &#x2F;&#x2F;每个TaskManager的slot的数量，默认最大并行度</span><br><span class="line">   int numSlotsPerTaskManager &#x3D; configuration.getInteger(</span><br><span class="line">         TaskManagerOptions.NUM_TASK_SLOTS,</span><br><span class="line">         jobGraph.getMaximumParallelism());</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;配置参数</span><br><span class="line">   final MiniClusterConfiguration miniClusterConfiguration &#x3D;</span><br><span class="line">         new MiniClusterConfiguration.Builder()</span><br><span class="line">               .setConfiguration(configuration)</span><br><span class="line">               .setNumTaskManagers(numTaskManagers)</span><br><span class="line">               .setRpcServiceSharing(RpcServiceSharing.SHARED)</span><br><span class="line">               .setNumSlotsPerTaskManager(numSlotsPerTaskManager)</span><br><span class="line">               .build();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;启动集群</span><br><span class="line">   final MiniCluster miniCluster &#x3D; new MiniCluster(miniClusterConfiguration);</span><br><span class="line">   miniCluster.start();</span><br><span class="line"></span><br><span class="line">   configuration.setInteger(RestOptions.PORT, miniCluster.getRestAddress().get().getPort());</span><br><span class="line"></span><br><span class="line">   return miniCluster;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MiniCluster类构造函数，定义了组件个数及超时时间等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public MiniCluster(MiniClusterConfiguration miniClusterConfiguration) &#123;</span><br><span class="line">   this.miniClusterConfiguration &#x3D; checkNotNull(miniClusterConfiguration, &quot;config may not be null&quot;);</span><br><span class="line">   &#x2F;&#x2F;需要启动的服务个数，common + JM + RM + TMs,commonRpcService用来进行一些额外的调用，比如获取metric等</span><br><span class="line">   this.rpcServices &#x3D; new ArrayList&lt;&gt;(1 + 2 + miniClusterConfiguration.getNumTaskManagers()); &#x2F;&#x2F; common + JM + RM + TMs</span><br><span class="line">   this.dispatcherResourceManagerComponents &#x3D; new ArrayList&lt;&gt;(1);</span><br><span class="line"></span><br><span class="line">   this.rpcTimeout &#x3D; miniClusterConfiguration.getRpcTimeout();</span><br><span class="line">   this.terminationFuture &#x3D; CompletableFuture.completedFuture(null);</span><br><span class="line">   running &#x3D; false;</span><br><span class="line"></span><br><span class="line">   this.taskManagers &#x3D; new ArrayList&lt;&gt;(miniClusterConfiguration.getNumTaskManagers());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MiniCluster类的start函数，启动MiniCluster的各个组件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">public void start() throws Exception &#123;</span><br><span class="line">   synchronized (lock) &#123;</span><br><span class="line">      checkState(!running, &quot;MiniCluster is already running&quot;);</span><br><span class="line"></span><br><span class="line">      LOG.info(&quot;Starting Flink Mini Cluster&quot;);</span><br><span class="line">      LOG.debug(&quot;Using configuration &#123;&#125;&quot;, miniClusterConfiguration);</span><br><span class="line"></span><br><span class="line">      final Configuration configuration &#x3D; miniClusterConfiguration.getConfiguration();</span><br><span class="line">      final boolean useSingleRpcService &#x3D; miniClusterConfiguration.getRpcServiceSharing() &#x3D;&#x3D; RpcServiceSharing.SHARED;</span><br><span class="line"></span><br><span class="line">      try &#123;</span><br><span class="line">         initializeIOFormatClasses(configuration);</span><br><span class="line"></span><br><span class="line">         LOG.info(&quot;Starting Metrics Registry&quot;);</span><br><span class="line">         metricRegistry &#x3D; createMetricRegistry(configuration);</span><br><span class="line"></span><br><span class="line">         &#x2F;&#x2F; bring up all the RPC services</span><br><span class="line">         LOG.info(&quot;Starting RPC Service(s)&quot;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;akka的Rpc服务</span><br><span class="line">         AkkaRpcServiceConfiguration akkaRpcServiceConfig &#x3D; AkkaRpcServiceConfiguration.fromConfiguration(configuration);</span><br><span class="line"></span><br><span class="line">         final RpcServiceFactory dispatcherResourceManagreComponentRpcServiceFactory;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;如果只用一个Rpc服务，则所有组件起在一个服务里</span><br><span class="line">         if (useSingleRpcService) &#123;</span><br><span class="line">            &#x2F;&#x2F; we always need the &#39;commonRpcService&#39; for auxiliary calls</span><br><span class="line">            commonRpcService &#x3D; createRpcService(akkaRpcServiceConfig, false, null);</span><br><span class="line">            final CommonRpcServiceFactory commonRpcServiceFactory &#x3D; new CommonRpcServiceFactory(commonRpcService);</span><br><span class="line">            taskManagerRpcServiceFactory &#x3D; commonRpcServiceFactory;</span><br><span class="line">            dispatcherResourceManagreComponentRpcServiceFactory &#x3D; commonRpcServiceFactory;</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">         &#x2F;&#x2F;不同的组件分开部署</span><br><span class="line">            &#x2F;&#x2F; we always need the &#39;commonRpcService&#39; for auxiliary calls</span><br><span class="line">            commonRpcService &#x3D; createRpcService(akkaRpcServiceConfig, true, null);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; start a new service per component, possibly with custom bind addresses</span><br><span class="line">            final String jobManagerBindAddress &#x3D; miniClusterConfiguration.getJobManagerBindAddress();</span><br><span class="line">            final String taskManagerBindAddress &#x3D; miniClusterConfiguration.getTaskManagerBindAddress();</span><br><span class="line"></span><br><span class="line">            dispatcherResourceManagreComponentRpcServiceFactory &#x3D; new DedicatedRpcServiceFactory(akkaRpcServiceConfig, jobManagerBindAddress);</span><br><span class="line">            taskManagerRpcServiceFactory &#x3D; new DedicatedRpcServiceFactory(akkaRpcServiceConfig, taskManagerBindAddress);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;metric查询服务</span><br><span class="line">         RpcService metricQueryServiceRpcService &#x3D; MetricUtils.startMetricsRpcService(</span><br><span class="line">            configuration,</span><br><span class="line">            commonRpcService.getAddress());</span><br><span class="line">         metricRegistry.startQueryService(metricQueryServiceRpcService, null);</span><br><span class="line"></span><br><span class="line">         processMetricGroup &#x3D; MetricUtils.instantiateProcessMetricGroup(</span><br><span class="line">            metricRegistry,</span><br><span class="line">            RpcUtils.getHostname(commonRpcService),</span><br><span class="line">            ConfigurationUtils.getSystemResourceMetricsProbingInterval(configuration));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;创建高可用HA服务</span><br><span class="line">         ioExecutor &#x3D; Executors.newFixedThreadPool(</span><br><span class="line">            Hardware.getNumberCPUCores(),</span><br><span class="line">            new ExecutorThreadFactory(&quot;mini-cluster-io&quot;));</span><br><span class="line">         haServices &#x3D; createHighAvailabilityServices(configuration, ioExecutor);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;启动blobServer</span><br><span class="line">         blobServer &#x3D; new BlobServer(configuration, haServices.createBlobStore());</span><br><span class="line">         blobServer.start();</span><br><span class="line"></span><br><span class="line">         heartbeatServices &#x3D; HeartbeatServices.fromConfiguration(configuration);</span><br><span class="line"></span><br><span class="line">         blobCacheService &#x3D; new BlobCacheService(</span><br><span class="line">            configuration, haServices.createBlobStore(), new InetSocketAddress(InetAddress.getLocalHost(), blobServer.getPort())</span><br><span class="line">         );</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;启动TaskManager</span><br><span class="line">         startTaskManagers();</span><br><span class="line"></span><br><span class="line">         MetricQueryServiceRetriever metricQueryServiceRetriever &#x3D; new RpcMetricQueryServiceRetriever(metricRegistry.getMetricQueryServiceRpcService());</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;创建DispatcherResourceManager</span><br><span class="line">         setupDispatcherResourceManagerComponents(configuration, dispatcherResourceManagreComponentRpcServiceFactory, metricQueryServiceRetriever);</span><br><span class="line"></span><br><span class="line">         resourceManagerLeaderRetriever &#x3D; haServices.getResourceManagerLeaderRetriever();</span><br><span class="line">         dispatcherLeaderRetriever &#x3D; haServices.getDispatcherLeaderRetriever();</span><br><span class="line">         clusterRestEndpointLeaderRetrievalService &#x3D; haServices.getClusterRestEndpointLeaderRetriever();</span><br><span class="line"></span><br><span class="line">         dispatcherGatewayRetriever &#x3D; new RpcGatewayRetriever&lt;&gt;(</span><br><span class="line">            commonRpcService,</span><br><span class="line">            DispatcherGateway.class,</span><br><span class="line">            DispatcherId::fromUuid,</span><br><span class="line">            20,</span><br><span class="line">            Time.milliseconds(20L));</span><br><span class="line">         resourceManagerGatewayRetriever &#x3D; new RpcGatewayRetriever&lt;&gt;(</span><br><span class="line">            commonRpcService,</span><br><span class="line">            ResourceManagerGateway.class,</span><br><span class="line">            ResourceManagerId::fromUuid,</span><br><span class="line">            20,</span><br><span class="line">            Time.milliseconds(20L));</span><br><span class="line">         webMonitorLeaderRetriever &#x3D; new LeaderRetriever();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;启动resourceManager及dispatcher</span><br><span class="line">         resourceManagerLeaderRetriever.start(resourceManagerGatewayRetriever);</span><br><span class="line">         dispatcherLeaderRetriever.start(dispatcherGatewayRetriever);</span><br><span class="line">         clusterRestEndpointLeaderRetrievalService.start(webMonitorLeaderRetriever);</span><br><span class="line">      &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来看下上面过程中的部分服务的启动，首先是创建<code>HighAvailabilityServices</code>，根据配置的HA模式来实现不同的HA类，如果没有配置则使用EmbeddedHaServices。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">protected HighAvailabilityServices createHighAvailabilityServices(Configuration configuration, Executor executor) throws Exception &#123;</span><br><span class="line">   LOG.info(&quot;Starting high-availability services&quot;);</span><br><span class="line">   return HighAvailabilityServicesUtils.createAvailableOrEmbeddedServices(</span><br><span class="line">      configuration,</span><br><span class="line">      executor);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class HighAvailabilityServicesUtils &#123;</span><br><span class="line"></span><br><span class="line">	public static HighAvailabilityServices createAvailableOrEmbeddedServices(</span><br><span class="line">		Configuration config,</span><br><span class="line">		Executor executor) throws Exception &#123;</span><br><span class="line">		HighAvailabilityMode highAvailabilityMode &#x3D; HighAvailabilityMode.fromConfig(config);</span><br><span class="line"></span><br><span class="line">		switch (highAvailabilityMode) &#123;</span><br><span class="line">			case NONE:</span><br><span class="line">				return new EmbeddedHaServices(executor);</span><br><span class="line"></span><br><span class="line">			case ZOOKEEPER:</span><br><span class="line">				BlobStoreService blobStoreService &#x3D; BlobUtils.createBlobStoreFromConfig(config);</span><br><span class="line"></span><br><span class="line">				return new ZooKeeperHaServices(</span><br><span class="line">					ZooKeeperUtils.startCuratorFramework(config),</span><br><span class="line">					executor,</span><br><span class="line">					config,</span><br><span class="line">					blobStoreService);</span><br><span class="line"></span><br><span class="line">			case FACTORY_CLASS:</span><br><span class="line">				return createCustomHAServices(config, executor);</span><br><span class="line"></span><br><span class="line">			default:</span><br><span class="line">				throw new Exception(&quot;High availability mode &quot; + highAvailabilityMode + &quot; is not supported.&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>接着是startTaskManagers，根据配置的numTaskManagers数量调用startTaskExecutor，<code>TaskManagerRunner#startTaskManager</code> 会创建一个 <code>TaskExecutor</code>, <code>TaskExecutor</code> 实现了 <code>RpcEndpoint</code>接口。 <code>TaskExecutor</code> 需要和 <code>ResourceManager</code> 等组件进行通信，可以通过 <code>HighAvailabilityServices</code>获得对应的服务地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private void startTaskManagers() throws Exception &#123;</span><br><span class="line">   final int numTaskManagers &#x3D; miniClusterConfiguration.getNumTaskManagers();</span><br><span class="line"></span><br><span class="line">   LOG.info(&quot;Starting &#123;&#125; TaskManger(s)&quot;, numTaskManagers);</span><br><span class="line"></span><br><span class="line">   for (int i &#x3D; 0; i &lt; numTaskManagers; i++) &#123;</span><br><span class="line">      startTaskExecutor();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void startTaskExecutor() throws Exception &#123;</span><br><span class="line">		synchronized (lock) &#123;</span><br><span class="line">			final Configuration configuration &#x3D; miniClusterConfiguration.getConfiguration();</span><br><span class="line"></span><br><span class="line">			final TaskExecutor taskExecutor &#x3D; TaskManagerRunner.startTaskManager(</span><br><span class="line">				configuration,</span><br><span class="line">				new ResourceID(UUID.randomUUID().toString()),</span><br><span class="line">				taskManagerRpcServiceFactory.createRpcService(),</span><br><span class="line">				haServices,</span><br><span class="line">				heartbeatServices,</span><br><span class="line">				metricRegistry,</span><br><span class="line">				blobCacheService,</span><br><span class="line">				useLocalCommunication(),</span><br><span class="line">				taskManagerTerminatingFatalErrorHandlerFactory.create(taskManagers.size()));</span><br><span class="line"></span><br><span class="line">			taskExecutor.start();</span><br><span class="line">			taskManagers.add(taskExecutor);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><code>TaskManagerRunner#startTaskManager</code>,创建TaskExecutor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public static TaskExecutor startTaskManager(</span><br><span class="line">      Configuration configuration,</span><br><span class="line">      ResourceID resourceID,</span><br><span class="line">      RpcService rpcService,</span><br><span class="line">      HighAvailabilityServices highAvailabilityServices,</span><br><span class="line">      HeartbeatServices heartbeatServices,</span><br><span class="line">      MetricRegistry metricRegistry,</span><br><span class="line">      BlobCacheService blobCacheService,</span><br><span class="line">      boolean localCommunicationOnly,</span><br><span class="line">      FatalErrorHandler fatalErrorHandler) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line"></span><br><span class="line">   InetAddress remoteAddress &#x3D; InetAddress.getByName(rpcService.getAddress());</span><br><span class="line"></span><br><span class="line">   final TaskExecutorResourceSpec taskExecutorResourceSpec &#x3D; TaskExecutorResourceUtils.resourceSpecFromConfig(configuration);</span><br><span class="line"></span><br><span class="line">   TaskManagerServicesConfiguration taskManagerServicesConfiguration &#x3D;</span><br><span class="line">      TaskManagerServicesConfiguration.fromConfiguration(</span><br><span class="line">         configuration,</span><br><span class="line">         resourceID,</span><br><span class="line">         remoteAddress,</span><br><span class="line">         localCommunicationOnly,</span><br><span class="line">         taskExecutorResourceSpec);</span><br><span class="line"></span><br><span class="line">   Tuple2&lt;TaskManagerMetricGroup, MetricGroup&gt; taskManagerMetricGroup &#x3D; MetricUtils.instantiateTaskManagerMetricGroup(</span><br><span class="line">      metricRegistry,</span><br><span class="line">      TaskManagerLocation.getHostName(remoteAddress),</span><br><span class="line">      resourceID,</span><br><span class="line">      taskManagerServicesConfiguration.getSystemResourceMetricsProbingInterval());</span><br><span class="line"></span><br><span class="line">   TaskManagerServices taskManagerServices &#x3D; TaskManagerServices.fromConfiguration(</span><br><span class="line">      taskManagerServicesConfiguration,</span><br><span class="line">      taskManagerMetricGroup.f1,</span><br><span class="line">      rpcService.getExecutor()); &#x2F;&#x2F; TODO replace this later with some dedicated executor for io.</span><br><span class="line"></span><br><span class="line">   TaskManagerConfiguration taskManagerConfiguration &#x3D;</span><br><span class="line">      TaskManagerConfiguration.fromConfiguration(configuration, taskExecutorResourceSpec);</span><br><span class="line"></span><br><span class="line">   String metricQueryServiceAddress &#x3D; metricRegistry.getMetricQueryServiceGatewayRpcAddress();</span><br><span class="line"></span><br><span class="line">   return new TaskExecutor(</span><br><span class="line">      rpcService,</span><br><span class="line">      taskManagerConfiguration,</span><br><span class="line">      highAvailabilityServices,</span><br><span class="line">      taskManagerServices,</span><br><span class="line">      heartbeatServices,</span><br><span class="line">      taskManagerMetricGroup.f0,</span><br><span class="line">      metricQueryServiceAddress,</span><br><span class="line">      blobCacheService,</span><br><span class="line">      fatalErrorHandler,</span><br><span class="line">      new TaskExecutorPartitionTrackerImpl(taskManagerServices.getShuffleEnvironment()),</span><br><span class="line">      createBackPressureSampleService(configuration, rpcService.getScheduledExecutor()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TaskExecutor实现了RpcEndpoint，创建TaskExecutor之后调用RpcEndpoint的start启动akkaRpcActor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class TaskExecutor extends RpcEndpoint implements TaskExecutorGateway</span><br></pre></td></tr></table></figure>

<p>启动akkaRpcActor成功会调用TaskExecutor的回调函数onStart，建立一系列连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void onStart() throws Exception &#123;</span><br><span class="line">   try &#123;</span><br><span class="line">      startTaskExecutorServices();</span><br><span class="line">   &#125; catch (Exception e) &#123;</span><br><span class="line">      final TaskManagerException exception &#x3D; new TaskManagerException(String.format(&quot;Could not start the TaskExecutor %s&quot;, getAddress()), e);</span><br><span class="line">      onFatalError(exception);</span><br><span class="line">      throw exception;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   startRegistrationTimeout();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private void startTaskExecutorServices() throws Exception &#123;</span><br><span class="line">		try &#123;</span><br><span class="line">			&#x2F;&#x2F; start by connecting to the ResourceManager</span><br><span class="line">			resourceManagerLeaderRetriever.start(new ResourceManagerLeaderListener());</span><br><span class="line"></span><br><span class="line">			&#x2F;&#x2F; tell the task slot table who&#39;s responsible for the task slot actions</span><br><span class="line">			taskSlotTable.start(new SlotActionsImpl(), getMainThreadExecutor());</span><br><span class="line"></span><br><span class="line">			&#x2F;&#x2F; start the job leader service</span><br><span class="line">			jobLeaderService.start(getAddress(), getRpcService(), haServices, new JobLeaderListenerImpl());</span><br><span class="line"></span><br><span class="line">			fileCache &#x3D; new FileCache(taskManagerConfiguration.getTmpDirectories(), blobCacheService.getPermanentBlobService());</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			handleStartTaskExecutorServicesException(e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	private final class ResourceManagerLeaderListener implements LeaderRetrievalListener &#123;</span><br><span class="line"></span><br><span class="line">		@Override</span><br><span class="line">		public void notifyLeaderAddress(final String leaderAddress, final UUID leaderSessionID) &#123;</span><br><span class="line">			runAsync(</span><br><span class="line">			&#x2F;&#x2F;与ResourceManager建立连接</span><br><span class="line">				() -&gt; notifyOfNewResourceManagerLeader(</span><br><span class="line">					leaderAddress,</span><br><span class="line">					ResourceManagerId.fromUuidOrNull(leaderSessionID)));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		@Override</span><br><span class="line">		public void handleError(Exception exception) &#123;</span><br><span class="line">			onFatalError(exception);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private final class JobLeaderListenerImpl implements JobLeaderListener &#123;</span><br><span class="line"></span><br><span class="line">		@Override</span><br><span class="line">		public void jobManagerGainedLeadership(</span><br><span class="line">			final JobID jobId,</span><br><span class="line">			final JobMasterGateway jobManagerGateway,</span><br><span class="line">			final JMTMRegistrationSuccess registrationMessage) &#123;</span><br><span class="line">			runAsync(</span><br><span class="line">				() -&gt;</span><br><span class="line">				&#x2F;&#x2F;与JobManager的leader节点建立连接</span><br><span class="line">					establishJobManagerConnection(</span><br><span class="line">						jobId,</span><br><span class="line">						jobManagerGateway,</span><br><span class="line">						registrationMessage));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		@Override</span><br><span class="line">		public void jobManagerLostLeadership(final JobID jobId, final JobMasterId jobMasterId) &#123;</span><br><span class="line">			log.info(&quot;JobManager for job &#123;&#125; with leader id &#123;&#125; lost leadership.&quot;, jobId, jobMasterId);</span><br><span class="line"></span><br><span class="line">			runAsync(() -&gt;</span><br><span class="line">				closeJobManagerConnection(</span><br><span class="line">					jobId,</span><br><span class="line">					new Exception(&quot;Job leader for job id &quot; + jobId + &quot; lost leadership.&quot;)));</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		@Override</span><br><span class="line">		public void handleError(Throwable throwable) &#123;</span><br><span class="line">			onFatalError(throwable);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>当 <code>ResourceManagerLeaderListener</code> 的监听被回调时，<code>TaskExecutor</code> 会试图建立和 <code>ResourceManager</code> 的连接，连接被封装为 <code>TaskExecutorToResourceManagerConnection</code>。一旦获取 <code>ResourceManager</code> 的 leader 被确定后，就可以获取到 <code>ResourceManager</code> 对应的 RpcGateway， 接下来就可以通过 RPC 调用发起 <code>ResourceManager#registerTaskExecutor</code> 注册流程。注册成功后，回调onRegistrationSuccess方法，<code>TaskExecutor</code> 向 <code>ResourceManager</code> 报告其资源（主要是 slots）情况，并建立连接。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line">private void connectToResourceManager() &#123;</span><br><span class="line">   assert(resourceManagerAddress !&#x3D; null);</span><br><span class="line">   assert(establishedResourceManagerConnection &#x3D;&#x3D; null);</span><br><span class="line">   assert(resourceManagerConnection &#x3D;&#x3D; null);</span><br><span class="line"></span><br><span class="line">   log.info(&quot;Connecting to ResourceManager &#123;&#125;.&quot;, resourceManagerAddress);</span><br><span class="line"></span><br><span class="line">   final TaskExecutorRegistration taskExecutorRegistration &#x3D; new TaskExecutorRegistration(</span><br><span class="line">      getAddress(),</span><br><span class="line">      getResourceID(),</span><br><span class="line">      taskManagerLocation.dataPort(),</span><br><span class="line">      hardwareDescription,</span><br><span class="line">      taskManagerConfiguration.getDefaultSlotResourceProfile(),</span><br><span class="line">      taskManagerConfiguration.getTotalResourceProfile()</span><br><span class="line">   );</span><br><span class="line"></span><br><span class="line">   resourceManagerConnection &#x3D;</span><br><span class="line">      new TaskExecutorToResourceManagerConnection(</span><br><span class="line">         log,</span><br><span class="line">         getRpcService(),</span><br><span class="line">         taskManagerConfiguration.getRetryingRegistrationConfiguration(),</span><br><span class="line">         resourceManagerAddress.getAddress(),</span><br><span class="line">         resourceManagerAddress.getResourceManagerId(),</span><br><span class="line">         getMainThreadExecutor(),</span><br><span class="line">         new ResourceManagerRegistrationListener(),</span><br><span class="line">         taskExecutorRegistration);</span><br><span class="line">   resourceManagerConnection.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">resourceManagerConnection.start()方法：</span><br><span class="line">public void start() &#123;</span><br><span class="line">		checkState(!closed, &quot;The RPC connection is already closed&quot;);</span><br><span class="line">		checkState(!isConnected() &amp;&amp; pendingRegistration &#x3D;&#x3D; null, &quot;The RPC connection is already started&quot;);</span><br><span class="line"></span><br><span class="line">		final RetryingRegistration&lt;F, G, S&gt; newRegistration &#x3D; createNewRegistration();</span><br><span class="line"></span><br><span class="line">		if (REGISTRATION_UPDATER.compareAndSet(this, null, newRegistration)) &#123;</span><br><span class="line">			newRegistration.startRegistration();</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			&#x2F;&#x2F; concurrent start operation</span><br><span class="line">			newRegistration.cancel();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">createNewRegistration方法：</span><br><span class="line">private RetryingRegistration&lt;F, G, S&gt; createNewRegistration() &#123;</span><br><span class="line">		RetryingRegistration&lt;F, G, S&gt; newRegistration &#x3D; checkNotNull(generateRegistration());</span><br><span class="line"></span><br><span class="line">		CompletableFuture&lt;Tuple2&lt;G, S&gt;&gt; future &#x3D; newRegistration.getFuture();</span><br><span class="line"></span><br><span class="line">		future.whenCompleteAsync(</span><br><span class="line">			(Tuple2&lt;G, S&gt; result, Throwable failure) -&gt; &#123;</span><br><span class="line">				if (failure !&#x3D; null) &#123;</span><br><span class="line">					if (failure instanceof CancellationException) &#123;</span><br><span class="line">						&#x2F;&#x2F; we ignore cancellation exceptions because they originate from cancelling</span><br><span class="line">						&#x2F;&#x2F; the RetryingRegistration</span><br><span class="line">						log.debug(&quot;Retrying registration towards &#123;&#125; was cancelled.&quot;, targetAddress);</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">						&#x2F;&#x2F; this future should only ever fail if there is a bug, not if the registration is declined</span><br><span class="line">						onRegistrationFailure(failure);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; else &#123;</span><br><span class="line">					targetGateway &#x3D; result.f0;</span><br><span class="line">					onRegistrationSuccess(result.f1);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;, executor);</span><br><span class="line"></span><br><span class="line">		return newRegistration;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;generateRegistration方法</span><br><span class="line">@Override</span><br><span class="line">	protected RetryingRegistration&lt;ResourceManagerId, ResourceManagerGateway, TaskExecutorRegistrationSuccess&gt; generateRegistration() &#123;</span><br><span class="line">		return new TaskExecutorToResourceManagerConnection.ResourceManagerRegistration(</span><br><span class="line">			log,</span><br><span class="line">			rpcService,</span><br><span class="line">			getTargetAddress(),</span><br><span class="line">			getTargetLeaderId(),</span><br><span class="line">			retryingRegistrationConfiguration,</span><br><span class="line">			taskExecutorRegistration);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TaskExecutorToResourceManagerConnection类内部类：</span><br><span class="line">private static class ResourceManagerRegistration</span><br><span class="line">			extends RetryingRegistration&lt;ResourceManagerId, ResourceManagerGateway, TaskExecutorRegistrationSuccess&gt; &#123;</span><br><span class="line"></span><br><span class="line">		private final TaskExecutorRegistration taskExecutorRegistration;</span><br><span class="line"></span><br><span class="line">		ResourceManagerRegistration(</span><br><span class="line">				Logger log,</span><br><span class="line">				RpcService rpcService,</span><br><span class="line">				String targetAddress,</span><br><span class="line">				ResourceManagerId resourceManagerId,</span><br><span class="line">				RetryingRegistrationConfiguration retryingRegistrationConfiguration,</span><br><span class="line">				TaskExecutorRegistration taskExecutorRegistration) &#123;</span><br><span class="line"></span><br><span class="line">			super(log, rpcService, &quot;ResourceManager&quot;, ResourceManagerGateway.class, targetAddress, resourceManagerId, retryingRegistrationConfiguration);</span><br><span class="line">			this.taskExecutorRegistration &#x3D; taskExecutorRegistration;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		@Override</span><br><span class="line">		protected CompletableFuture&lt;RegistrationResponse&gt; invokeRegistration(</span><br><span class="line">				ResourceManagerGateway resourceManager, ResourceManagerId fencingToken, long timeoutMillis) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">			Time timeout &#x3D; Time.milliseconds(timeoutMillis);</span><br><span class="line">			&#x2F;&#x2F;register taskExecutor</span><br><span class="line">			return resourceManager.registerTaskExecutor(</span><br><span class="line">				taskExecutorRegistration,</span><br><span class="line">				timeout);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TaskExecutorToResourceManagerConnection类：</span><br><span class="line">&#x2F;&#x2F;完成上述Registration回调onRegistrationSuccess</span><br><span class="line">@Override</span><br><span class="line">	protected void onRegistrationSuccess(TaskExecutorRegistrationSuccess success) &#123;</span><br><span class="line">		log.info(&quot;Successful registration at resource manager &#123;&#125; under registration id &#123;&#125;.&quot;,</span><br><span class="line">			getTargetAddress(), success.getRegistrationId());</span><br><span class="line"></span><br><span class="line">		registrationListener.onRegistrationSuccess(this, success);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	TaskExecutor类内部的ResourceManagerRegistrationListener类：</span><br><span class="line">	public void onRegistrationSuccess(TaskExecutorToResourceManagerConnection connection, TaskExecutorRegistrationSuccess success) &#123;</span><br><span class="line">			final ResourceID resourceManagerId &#x3D; success.getResourceManagerId();</span><br><span class="line">			final InstanceID taskExecutorRegistrationId &#x3D; success.getRegistrationId();</span><br><span class="line">			final ClusterInformation clusterInformation &#x3D; success.getClusterInformation();</span><br><span class="line">			final ResourceManagerGateway resourceManagerGateway &#x3D; connection.getTargetGateway();</span><br><span class="line"></span><br><span class="line">			runAsync(</span><br><span class="line">				() -&gt; &#123;</span><br><span class="line">					&#x2F;&#x2F; filter out outdated connections</span><br><span class="line">					&#x2F;&#x2F;noinspection ObjectEquality</span><br><span class="line">					if (resourceManagerConnection &#x3D;&#x3D; connection) &#123;</span><br><span class="line">						establishResourceManagerConnection(</span><br><span class="line">							resourceManagerGateway,</span><br><span class="line">							resourceManagerId,</span><br><span class="line">							taskExecutorRegistrationId,</span><br><span class="line">							clusterInformation);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">private void establishResourceManagerConnection(</span><br><span class="line">			ResourceManagerGateway resourceManagerGateway,</span><br><span class="line">			ResourceID resourceManagerResourceId,</span><br><span class="line">			InstanceID taskExecutorRegistrationId,</span><br><span class="line">			ClusterInformation clusterInformation) &#123;</span><br><span class="line">&#x2F;&#x2F;发送SlotReport</span><br><span class="line">		final CompletableFuture&lt;Acknowledge&gt; slotReportResponseFuture &#x3D; resourceManagerGateway.sendSlotReport(</span><br><span class="line">			getResourceID(),</span><br><span class="line">			taskExecutorRegistrationId,</span><br><span class="line">			taskSlotTable.createSlotReport(getResourceID()),</span><br><span class="line">			taskManagerConfiguration.getTimeout());</span><br><span class="line"></span><br><span class="line">		slotReportResponseFuture.whenCompleteAsync(</span><br><span class="line">			(acknowledge, throwable) -&gt; &#123;</span><br><span class="line">				if (throwable !&#x3D; null) &#123;</span><br><span class="line">					reconnectToResourceManager(new TaskManagerException(&quot;Failed to send initial slot report to ResourceManager.&quot;, throwable));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;, getMainThreadExecutor());</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; monitor the resource manager as heartbeat target</span><br><span class="line">		resourceManagerHeartbeatManager.monitorTarget(resourceManagerResourceId, new HeartbeatTarget&lt;TaskExecutorHeartbeatPayload&gt;() &#123;</span><br><span class="line">			@Override</span><br><span class="line">			public void receiveHeartbeat(ResourceID resourceID, TaskExecutorHeartbeatPayload heartbeatPayload) &#123;</span><br><span class="line">				resourceManagerGateway.heartbeatFromTaskManager(resourceID, heartbeatPayload);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			@Override</span><br><span class="line">			public void requestHeartbeat(ResourceID resourceID, TaskExecutorHeartbeatPayload heartbeatPayload) &#123;</span><br><span class="line">				&#x2F;&#x2F; the TaskManager won&#39;t send heartbeat requests to the ResourceManager</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; set the propagated blob server address</span><br><span class="line">		final InetSocketAddress blobServerAddress &#x3D; new InetSocketAddress(</span><br><span class="line">			clusterInformation.getBlobServerHostname(),</span><br><span class="line">			clusterInformation.getBlobServerPort());</span><br><span class="line"></span><br><span class="line">		blobCacheService.setBlobServerAddress(blobServerAddress);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;连接建立</span><br><span class="line">		establishedResourceManagerConnection &#x3D; new EstablishedResourceManagerConnection(</span><br><span class="line">			resourceManagerGateway,</span><br><span class="line">			resourceManagerResourceId,</span><br><span class="line">			taskExecutorRegistrationId);</span><br><span class="line"></span><br><span class="line">		stopRegistrationTimeout();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>最后，启动完taskmanager进入DispatcherResourceManagerComponent的启动过程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">private void setupDispatcherResourceManagerComponents(Configuration configuration, RpcServiceFactory dispatcherResourceManagreComponentRpcServiceFactory, MetricQueryServiceRetriever metricQueryServiceRetriever) throws Exception &#123;</span><br><span class="line">   dispatcherResourceManagerComponents.addAll(createDispatcherResourceManagerComponents(</span><br><span class="line">      configuration,</span><br><span class="line">      dispatcherResourceManagreComponentRpcServiceFactory,</span><br><span class="line">      haServices,</span><br><span class="line">      blobServer,</span><br><span class="line">      heartbeatServices,</span><br><span class="line">      metricRegistry,</span><br><span class="line">      metricQueryServiceRetriever,</span><br><span class="line">      new ShutDownFatalErrorHandler()</span><br><span class="line">   ));</span><br><span class="line"></span><br><span class="line">   ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>createDispatcherResourceManagerComponents:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">protected Collection&lt;? extends DispatcherResourceManagerComponent&gt; createDispatcherResourceManagerComponents(</span><br><span class="line">      Configuration configuration,</span><br><span class="line">      RpcServiceFactory rpcServiceFactory,</span><br><span class="line">      HighAvailabilityServices haServices,</span><br><span class="line">      BlobServer blobServer,</span><br><span class="line">      HeartbeatServices heartbeatServices,</span><br><span class="line">      MetricRegistry metricRegistry,</span><br><span class="line">      MetricQueryServiceRetriever metricQueryServiceRetriever,</span><br><span class="line">      FatalErrorHandler fatalErrorHandler) throws Exception &#123;</span><br><span class="line">   DispatcherResourceManagerComponentFactory dispatcherResourceManagerComponentFactory &#x3D; createDispatcherResourceManagerComponentFactory();</span><br><span class="line">   return Collections.singleton(</span><br><span class="line">      dispatcherResourceManagerComponentFactory.create(</span><br><span class="line">         configuration,</span><br><span class="line">         ioExecutor,</span><br><span class="line">         rpcServiceFactory.createRpcService(),</span><br><span class="line">         haServices,</span><br><span class="line">         blobServer,</span><br><span class="line">         heartbeatServices,</span><br><span class="line">         metricRegistry,</span><br><span class="line">         new MemoryArchivedExecutionGraphStore(),</span><br><span class="line">         metricQueryServiceRetriever,</span><br><span class="line">         fatalErrorHandler));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>createDispatcherResourceManagerComponentFactory方法，分别得到Dispatcher，ResourceManager及restEndpoint组件的工厂类。分别是SessionDispatcherLeaderProcessFactoryFactory，StandaloneResourceManagerFactory以及SessionRestEndpointFactory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">private DispatcherResourceManagerComponentFactory createDispatcherResourceManagerComponentFactory() &#123;</span><br><span class="line">   return DefaultDispatcherResourceManagerComponentFactory.createSessionComponentFactory(StandaloneResourceManagerFactory.INSTANCE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public static DefaultDispatcherResourceManagerComponentFactory createSessionComponentFactory(</span><br><span class="line">			ResourceManagerFactory&lt;?&gt; resourceManagerFactory) &#123;</span><br><span class="line">		return new DefaultDispatcherResourceManagerComponentFactory(</span><br><span class="line">			DefaultDispatcherRunnerFactory.createSessionRunner(SessionDispatcherFactory.INSTANCE),</span><br><span class="line">			resourceManagerFactory,</span><br><span class="line">			SessionRestEndpointFactory.INSTANCE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DefaultDispatcherResourceManagerComponentFactory(</span><br><span class="line">			@Nonnull DispatcherRunnerFactory dispatcherRunnerFactory,</span><br><span class="line">			@Nonnull ResourceManagerFactory&lt;?&gt; resourceManagerFactory,</span><br><span class="line">			@Nonnull RestEndpointFactory&lt;?&gt; restEndpointFactory) &#123;</span><br><span class="line">		this.dispatcherRunnerFactory &#x3D; dispatcherRunnerFactory;</span><br><span class="line">		this.resourceManagerFactory &#x3D; resourceManagerFactory;</span><br><span class="line">		this.restEndpointFactory &#x3D; restEndpointFactory;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>DefaultDispatcherResourceManagerComponentFactory类create方法创建Dispatcher，ResourceManager及restEndpoint组件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">public DispatcherResourceManagerComponent create(</span><br><span class="line">      Configuration configuration,</span><br><span class="line">      Executor ioExecutor,</span><br><span class="line">      RpcService rpcService,</span><br><span class="line">      HighAvailabilityServices highAvailabilityServices,</span><br><span class="line">      BlobServer blobServer,</span><br><span class="line">      HeartbeatServices heartbeatServices,</span><br><span class="line">      MetricRegistry metricRegistry,</span><br><span class="line">      ArchivedExecutionGraphStore archivedExecutionGraphStore,</span><br><span class="line">      MetricQueryServiceRetriever metricQueryServiceRetriever,</span><br><span class="line">      FatalErrorHandler fatalErrorHandler) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">   LeaderRetrievalService dispatcherLeaderRetrievalService &#x3D; null;</span><br><span class="line">   LeaderRetrievalService resourceManagerRetrievalService &#x3D; null;</span><br><span class="line">   WebMonitorEndpoint&lt;?&gt; webMonitorEndpoint &#x3D; null;</span><br><span class="line">   ResourceManager&lt;?&gt; resourceManager &#x3D; null;</span><br><span class="line">   ResourceManagerMetricGroup resourceManagerMetricGroup &#x3D; null;</span><br><span class="line">   DispatcherRunner dispatcherRunner &#x3D; null;</span><br><span class="line"></span><br><span class="line">      dispatcherLeaderRetrievalService &#x3D; highAvailabilityServices.getDispatcherLeaderRetriever();</span><br><span class="line"></span><br><span class="line">      resourceManagerRetrievalService &#x3D; highAvailabilityServices.getResourceManagerLeaderRetriever();</span><br><span class="line"></span><br><span class="line">      final LeaderGatewayRetriever&lt;DispatcherGateway&gt; dispatcherGatewayRetriever &#x3D; new RpcGatewayRetriever&lt;&gt;(</span><br><span class="line">         rpcService,</span><br><span class="line">         DispatcherGateway.class,</span><br><span class="line">         DispatcherId::fromUuid,</span><br><span class="line">         10,</span><br><span class="line">         Time.milliseconds(50L));</span><br><span class="line"></span><br><span class="line">      final LeaderGatewayRetriever&lt;ResourceManagerGateway&gt; resourceManagerGatewayRetriever &#x3D; new RpcGatewayRetriever&lt;&gt;(</span><br><span class="line">         rpcService,</span><br><span class="line">         ResourceManagerGateway.class,</span><br><span class="line">         ResourceManagerId::fromUuid,</span><br><span class="line">         10,</span><br><span class="line">         Time.milliseconds(50L));</span><br><span class="line"></span><br><span class="line">      final ExecutorService executor &#x3D; WebMonitorEndpoint.createExecutorService(</span><br><span class="line">         configuration.getInteger(RestOptions.SERVER_NUM_THREADS),</span><br><span class="line">         configuration.getInteger(RestOptions.SERVER_THREAD_PRIORITY),</span><br><span class="line">         &quot;DispatcherRestEndpoint&quot;);</span><br><span class="line"></span><br><span class="line">      final long updateInterval &#x3D; configuration.getLong(MetricOptions.METRIC_FETCHER_UPDATE_INTERVAL);</span><br><span class="line">      final MetricFetcher metricFetcher &#x3D; updateInterval &#x3D;&#x3D; 0</span><br><span class="line">         ? VoidMetricFetcher.INSTANCE</span><br><span class="line">         : MetricFetcherImpl.fromConfiguration(</span><br><span class="line">            configuration,</span><br><span class="line">            metricQueryServiceRetriever,</span><br><span class="line">            dispatcherGatewayRetriever,</span><br><span class="line">            executor);</span><br><span class="line"></span><br><span class="line">      webMonitorEndpoint &#x3D; restEndpointFactory.createRestEndpoint(</span><br><span class="line">         configuration,</span><br><span class="line">         dispatcherGatewayRetriever,</span><br><span class="line">         resourceManagerGatewayRetriever,</span><br><span class="line">         blobServer,</span><br><span class="line">         executor,</span><br><span class="line">         metricFetcher,</span><br><span class="line">         highAvailabilityServices.getClusterRestEndpointLeaderElectionService(),</span><br><span class="line">         fatalErrorHandler);</span><br><span class="line"></span><br><span class="line">      log.debug(&quot;Starting Dispatcher REST endpoint.&quot;);</span><br><span class="line">      webMonitorEndpoint.start();</span><br><span class="line"></span><br><span class="line">      final String hostname &#x3D; RpcUtils.getHostname(rpcService);</span><br><span class="line"></span><br><span class="line">      resourceManagerMetricGroup &#x3D; ResourceManagerMetricGroup.create(metricRegistry, hostname);</span><br><span class="line">      resourceManager &#x3D; resourceManagerFactory.createResourceManager(</span><br><span class="line">         configuration,</span><br><span class="line">         ResourceID.generate(),</span><br><span class="line">         rpcService,</span><br><span class="line">         highAvailabilityServices,</span><br><span class="line">         heartbeatServices,</span><br><span class="line">         fatalErrorHandler,</span><br><span class="line">         new ClusterInformation(hostname, blobServer.getPort()),</span><br><span class="line">         webMonitorEndpoint.getRestBaseUrl(),</span><br><span class="line">         resourceManagerMetricGroup);</span><br><span class="line"></span><br><span class="line">      final HistoryServerArchivist historyServerArchivist &#x3D; HistoryServerArchivist.createHistoryServerArchivist(configuration, webMonitorEndpoint);</span><br><span class="line"></span><br><span class="line">      final PartialDispatcherServices partialDispatcherServices &#x3D; new PartialDispatcherServices(</span><br><span class="line">         configuration,</span><br><span class="line">         highAvailabilityServices,</span><br><span class="line">         resourceManagerGatewayRetriever,</span><br><span class="line">         blobServer,</span><br><span class="line">         heartbeatServices,</span><br><span class="line">         () -&gt; MetricUtils.instantiateJobManagerMetricGroup(metricRegistry, hostname),</span><br><span class="line">         archivedExecutionGraphStore,</span><br><span class="line">         fatalErrorHandler,</span><br><span class="line">         historyServerArchivist,</span><br><span class="line">         metricRegistry.getMetricQueryServiceGatewayRpcAddress());</span><br><span class="line"></span><br><span class="line">      log.debug(&quot;Starting Dispatcher.&quot;);</span><br><span class="line">      dispatcherRunner &#x3D; dispatcherRunnerFactory.createDispatcherRunner(</span><br><span class="line">         highAvailabilityServices.getDispatcherLeaderElectionService(),</span><br><span class="line">         fatalErrorHandler,</span><br><span class="line">         new HaServicesJobGraphStoreFactory(highAvailabilityServices),</span><br><span class="line">         ioExecutor,</span><br><span class="line">         rpcService,</span><br><span class="line">         partialDispatcherServices);</span><br><span class="line"></span><br><span class="line">      log.debug(&quot;Starting ResourceManager.&quot;);</span><br><span class="line">      resourceManager.start();</span><br><span class="line"></span><br><span class="line">      resourceManagerRetrievalService.start(resourceManagerGatewayRetriever);</span><br><span class="line">      dispatcherLeaderRetrievalService.start(dispatcherGatewayRetriever);</span><br><span class="line"></span><br><span class="line">      return new DispatcherResourceManagerComponent(</span><br><span class="line">         dispatcherRunner,</span><br><span class="line">         resourceManager,</span><br><span class="line">         dispatcherLeaderRetrievalService,</span><br><span class="line">         resourceManagerRetrievalService,</span><br><span class="line">         webMonitorEndpoint);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Starting Dispatcher REST endpoint，Dispatcher REST为WebMonitorEndpoint类继承自RestServerEndpoint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public class WebMonitorEndpoint&lt;T extends RestfulGateway&gt; extends RestServerEndpoint implements LeaderContender, JsonArchivist</span><br></pre></td></tr></table></figure>

<p>Starting Dispatcher，创建DispatcherRunner，由LeaderElectionService启动DispatcherRunner</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">public DispatcherRunner createDispatcherRunner(</span><br><span class="line">      LeaderElectionService leaderElectionService,</span><br><span class="line">      FatalErrorHandler fatalErrorHandler,</span><br><span class="line">      JobGraphStoreFactory jobGraphStoreFactory,</span><br><span class="line">      Executor ioExecutor,</span><br><span class="line">      RpcService rpcService,</span><br><span class="line">      PartialDispatcherServices partialDispatcherServices) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">   final DispatcherLeaderProcessFactory dispatcherLeaderProcessFactory &#x3D; dispatcherLeaderProcessFactoryFactory.createFactory(</span><br><span class="line">      jobGraphStoreFactory,</span><br><span class="line">      ioExecutor,</span><br><span class="line">      rpcService,</span><br><span class="line">      partialDispatcherServices,</span><br><span class="line">      fatalErrorHandler);</span><br><span class="line"></span><br><span class="line">   return DefaultDispatcherRunner.create(</span><br><span class="line">      leaderElectionService,</span><br><span class="line">      fatalErrorHandler,</span><br><span class="line">      dispatcherLeaderProcessFactory);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public static DispatcherRunner create(</span><br><span class="line">			LeaderElectionService leaderElectionService,</span><br><span class="line">			FatalErrorHandler fatalErrorHandler,</span><br><span class="line">			DispatcherLeaderProcessFactory dispatcherLeaderProcessFactory) throws Exception &#123;</span><br><span class="line">		final DefaultDispatcherRunner dispatcherRunner &#x3D; new DefaultDispatcherRunner(</span><br><span class="line">			leaderElectionService,</span><br><span class="line">			fatalErrorHandler,</span><br><span class="line">			dispatcherLeaderProcessFactory);</span><br><span class="line">		return DispatcherRunnerLeaderElectionLifecycleManager.createFor(dispatcherRunner, leaderElectionService);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">private DispatcherRunnerLeaderElectionLifecycleManager(T dispatcherRunner, LeaderElectionService leaderElectionService) throws Exception &#123;</span><br><span class="line">		this.dispatcherRunner &#x3D; dispatcherRunner;</span><br><span class="line">		this.leaderElectionService &#x3D; leaderElectionService;</span><br><span class="line"></span><br><span class="line">		leaderElectionService.start(dispatcherRunner);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>Starting ResourceManager，ResourceManager继承自FencedRpcEndpoint即RpcEndpoint</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public abstract class ResourceManager&lt;WorkerType extends ResourceIDRetrievable&gt;</span><br><span class="line">      extends FencedRpcEndpoint&lt;ResourceManagerId&gt;</span><br><span class="line">      implements ResourceManagerGateway, LeaderContender</span><br></pre></td></tr></table></figure>

<p>创建所有组件成功，返回DispatcherResourceManagerComponent类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DispatcherResourceManagerComponent(</span><br><span class="line">      @Nonnull DispatcherRunner dispatcherRunner,</span><br><span class="line">      @Nonnull ResourceManager&lt;?&gt; resourceManager,</span><br><span class="line">      @Nonnull LeaderRetrievalService dispatcherLeaderRetrievalService,</span><br><span class="line">      @Nonnull LeaderRetrievalService resourceManagerRetrievalService,</span><br><span class="line">      @Nonnull WebMonitorEndpoint&lt;?&gt; webMonitorEndpoint) &#123;</span><br><span class="line">   this.dispatcherRunner &#x3D; dispatcherRunner;</span><br><span class="line">   this.resourceManager &#x3D; resourceManager;</span><br><span class="line">   this.dispatcherLeaderRetrievalService &#x3D; dispatcherLeaderRetrievalService;</span><br><span class="line">   this.resourceManagerRetrievalService &#x3D; resourceManagerRetrievalService;</span><br><span class="line">   this.webMonitorEndpoint &#x3D; webMonitorEndpoint;</span><br><span class="line">   this.terminationFuture &#x3D; new CompletableFuture&lt;&gt;();</span><br><span class="line">   this.shutDownFuture &#x3D; new CompletableFuture&lt;&gt;();</span><br><span class="line"></span><br><span class="line">   registerShutDownFuture();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/04/flink%E7%9A%84Elasticsearch%E7%9A%84connector%E4%BD%BF%E7%94%A8/" rel="next" title="flink的Elasticsearch的connector使用">
                <i class="fa fa-chevron-left"></i> flink的Elasticsearch的connector使用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/06/12/selenium%E8%87%AA%E5%8A%A8%E5%88%A0%E9%99%A4%E5%BE%AE%E5%8D%9A/" rel="prev" title="selenium自动删除微博">
                selenium自动删除微博 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">HH KKs</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HH KKs</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
